{"version":3,"file":"kairos.min.js","sources":["../src/adapters/MercadoPagoAdapter.ts","../src/adapters/PagSeguroAdapter.ts","../src/crypto/encryption.ts","../src/adapters/KairosEncryptedAdapter.ts","../src/core/KairosPayments.ts","../src/components/CardPaymentForm.tsx","../src/core/PaymentPoller.ts","../src/index.ts"],"sourcesContent":["import type {\n  PspAdapter,\n  CardPaymentConfig,\n  CardPaymentInstance,\n  InstallmentOption,\n  PaymentData\n} from '../types';\n\ndeclare global {\n  interface Window {\n    MercadoPago: any;\n  }\n}\n\n/**\n * MercadoPago Adapter\n *\n * Uses MercadoPago Bricks for card payment UI.\n * @see https://www.mercadopago.com.br/developers/pt/docs/checkout-bricks\n */\nexport class MercadoPagoAdapter implements PspAdapter {\n  readonly provider = 'MERCADOPAGO';\n\n  private mp: any = null;\n  private bricksBuilder: any = null;\n  private cardPaymentBrick: any = null;\n  private publicKey: string = '';\n\n  /**\n   * Load MercadoPago SDK script dynamically.\n   */\n  private async loadScript(): Promise<void> {\n    if (window.MercadoPago) {\n      return;\n    }\n\n    return new Promise((resolve, reject) => {\n      const script = document.createElement('script');\n      script.src = 'https://sdk.mercadopago.com/js/v2';\n      script.async = true;\n      script.onload = () => resolve();\n      script.onerror = () => reject(new Error('Failed to load MercadoPago SDK'));\n      document.head.appendChild(script);\n    });\n  }\n\n  async init(publicKey: string, options?: Record<string, unknown>): Promise<void> {\n    this.publicKey = publicKey;\n\n    await this.loadScript();\n\n    this.mp = new window.MercadoPago(publicKey, {\n      locale: options?.locale || 'pt-BR'\n    });\n\n    this.bricksBuilder = this.mp.bricks();\n  }\n\n  async createCardPayment(\n    container: string | HTMLElement,\n    config: CardPaymentConfig\n  ): Promise<CardPaymentInstance> {\n    const containerId = typeof container === 'string'\n      ? container.replace('#', '')\n      : container.id;\n\n    // Clear any existing brick\n    if (this.cardPaymentBrick) {\n      await this.cardPaymentBrick.unmount();\n    }\n\n    const settings = {\n      initialization: {\n        amount: config.amount,\n        payer: {\n          email: ''\n        }\n      },\n      customization: {\n        visual: {\n          style: {\n            customVariables: {\n              formBackgroundColor: config.styles?.primaryColor || '#ffffff',\n              baseColor: config.styles?.primaryColor || '#1a1a1a'\n            }\n          }\n        },\n        paymentMethods: {\n          maxInstallments: config.maxInstallments || 12\n        }\n      },\n      callbacks: {\n        onReady: () => {\n          config.onReady?.();\n        },\n        onSubmit: async (cardFormData: any) => {\n          const paymentData: PaymentData = {\n            token: cardFormData.token,\n            installments: cardFormData.installments,\n            paymentMethodId: cardFormData.payment_method_id,\n            issuerId: cardFormData.issuer_id,\n            lastFourDigits: cardFormData.last_four_digits || '',\n            cardholderName: cardFormData.cardholder?.name || '',\n            provider: this.provider\n          };\n\n          await config.onSubmit(paymentData);\n        },\n        onError: (error: any) => {\n          config.onError?.({\n            code: error.type || 'UNKNOWN',\n            message: error.message || 'An error occurred',\n            cause: error\n          });\n        }\n      }\n    };\n\n    this.cardPaymentBrick = await this.bricksBuilder.create(\n      'cardPayment',\n      containerId,\n      settings\n    );\n\n    return {\n      updateAmount: (amount: number) => {\n        // MercadoPago Bricks doesn't support dynamic amount update\n        // Would need to recreate the brick\n        console.warn('MercadoPago Bricks does not support dynamic amount update');\n      },\n      submit: async () => {\n        // Bricks handles submission internally\n        throw new Error('Use form submission instead');\n      },\n      unmount: () => {\n        this.cardPaymentBrick?.unmount();\n        this.cardPaymentBrick = null;\n      }\n    };\n  }\n\n  async getInstallments(amount: number, bin: string): Promise<InstallmentOption[]> {\n    const response = await this.mp.getInstallments({\n      amount: String(amount),\n      bin: bin\n    });\n\n    if (!response || response.length === 0) {\n      return [];\n    }\n\n    const payerCosts = response[0].payer_costs || [];\n\n    return payerCosts.map((cost: any, index: number) => ({\n      installments: cost.installments,\n      installmentAmount: cost.installment_amount,\n      totalAmount: cost.total_amount,\n      interestFree: cost.installment_rate === 0,\n      interestRate: cost.installment_rate,\n      recommended: index === 0\n    }));\n  }\n\n  destroy(): void {\n    if (this.cardPaymentBrick) {\n      this.cardPaymentBrick.unmount();\n      this.cardPaymentBrick = null;\n    }\n    this.mp = null;\n    this.bricksBuilder = null;\n  }\n}\n","import type {\n  PspAdapter,\n  CardPaymentConfig,\n  CardPaymentInstance,\n  InstallmentOption,\n  PaymentData\n} from '../types';\n\ndeclare global {\n  interface Window {\n    PagSeguro: any;\n  }\n}\n\n/**\n * PagSeguro (PagBank) Adapter\n *\n * @see https://dev.pagbank.uol.com.br/docs\n */\nexport class PagSeguroAdapter implements PspAdapter {\n  readonly provider = 'PAGSEGURO';\n\n  private publicKey: string = '';\n  private environment: string = 'sandbox';\n\n  /**\n   * Load PagSeguro SDK script dynamically.\n   */\n  private async loadScript(): Promise<void> {\n    if (window.PagSeguro) {\n      return;\n    }\n\n    const scriptUrl = this.environment === 'production'\n      ? 'https://assets.pagseguro.com.br/checkout-sdk-js/rc/dist/browser/pagseguro.min.js'\n      : 'https://stc.sandbox.pagseguro.uol.com.br/pagseguro/api/v2/checkout/pagseguro.directpayment.js';\n\n    return new Promise((resolve, reject) => {\n      const script = document.createElement('script');\n      script.src = scriptUrl;\n      script.async = true;\n      script.onload = () => resolve();\n      script.onerror = () => reject(new Error('Failed to load PagSeguro SDK'));\n      document.head.appendChild(script);\n    });\n  }\n\n  async init(publicKey: string, options?: Record<string, unknown>): Promise<void> {\n    this.publicKey = publicKey;\n    this.environment = (options?.environment as string) || 'sandbox';\n\n    await this.loadScript();\n\n    // PagSeguro requires session initialization\n    // This would typically be done via your backend\n  }\n\n  async createCardPayment(\n    container: string | HTMLElement,\n    config: CardPaymentConfig\n  ): Promise<CardPaymentInstance> {\n    const containerEl = typeof container === 'string'\n      ? document.querySelector(container)\n      : container;\n\n    if (!containerEl) {\n      throw new Error(`Container not found: ${container}`);\n    }\n\n    // PagSeguro doesn't have a pre-built form like MercadoPago Bricks\n    // We need to create our own form and use their tokenization API\n    const formHtml = this.createFormHtml(config);\n    containerEl.innerHTML = formHtml;\n\n    const form = containerEl.querySelector('form') as HTMLFormElement;\n\n    form.addEventListener('submit', async (e) => {\n      e.preventDefault();\n\n      try {\n        const formData = new FormData(form);\n        const token = await this.tokenizeCard(formData);\n\n        const paymentData: PaymentData = {\n          token,\n          installments: parseInt(formData.get('installments') as string) || 1,\n          paymentMethodId: 'credit_card',\n          issuerId: '',\n          lastFourDigits: (formData.get('cardNumber') as string)?.slice(-4) || '',\n          cardholderName: formData.get('cardholderName') as string || '',\n          provider: this.provider\n        };\n\n        await config.onSubmit(paymentData);\n      } catch (error: any) {\n        config.onError?.({\n          code: 'TOKENIZATION_ERROR',\n          message: error.message || 'Failed to tokenize card',\n          cause: error\n        });\n      }\n    });\n\n    config.onReady?.();\n\n    return {\n      updateAmount: (amount: number) => {\n        const amountEl = form.querySelector('[data-amount]');\n        if (amountEl) {\n          amountEl.textContent = `R$ ${amount.toFixed(2)}`;\n        }\n      },\n      submit: async () => {\n        form.dispatchEvent(new Event('submit'));\n        return {} as PaymentData; // Will be handled by onSubmit\n      },\n      unmount: () => {\n        containerEl.innerHTML = '';\n      }\n    };\n  }\n\n  private createFormHtml(config: CardPaymentConfig): string {\n    return `\n      <form class=\"kairos-card-form\" data-kairos-form>\n        <div class=\"kairos-field\">\n          <label for=\"cardNumber\">Numero do Cartao</label>\n          <input type=\"text\" id=\"cardNumber\" name=\"cardNumber\"\n                 placeholder=\"0000 0000 0000 0000\"\n                 maxlength=\"19\" required />\n        </div>\n\n        <div class=\"kairos-field-row\">\n          <div class=\"kairos-field\">\n            <label for=\"expiry\">Validade</label>\n            <input type=\"text\" id=\"expiry\" name=\"expiry\"\n                   placeholder=\"MM/AA\" maxlength=\"5\" required />\n          </div>\n          <div class=\"kairos-field\">\n            <label for=\"cvv\">CVV</label>\n            <input type=\"text\" id=\"cvv\" name=\"cvv\"\n                   placeholder=\"123\" maxlength=\"3\" required />\n          </div>\n        </div>\n\n        <div class=\"kairos-field\">\n          <label for=\"cardholderName\">Nome no Cartao</label>\n          <input type=\"text\" id=\"cardholderName\" name=\"cardholderName\"\n                 placeholder=\"NOME COMO NO CARTAO\" required />\n        </div>\n\n        ${config.showInstallments !== false ? `\n        <div class=\"kairos-field\">\n          <label for=\"installments\">Parcelas</label>\n          <select id=\"installments\" name=\"installments\">\n            <option value=\"1\">1x de R$ ${config.amount.toFixed(2)}</option>\n          </select>\n        </div>\n        ` : ''}\n\n        <button type=\"submit\" class=\"kairos-submit-btn\">\n          Pagar <span data-amount>R$ ${config.amount.toFixed(2)}</span>\n        </button>\n      </form>\n    `;\n  }\n\n  private async tokenizeCard(formData: FormData): Promise<string> {\n    // PagSeguro card tokenization\n    // In a real implementation, this would call PagSeguro's API\n    const cardNumber = (formData.get('cardNumber') as string)?.replace(/\\s/g, '');\n    const [expMonth, expYear] = (formData.get('expiry') as string)?.split('/') || [];\n    const cvv = formData.get('cvv') as string;\n    const cardholderName = formData.get('cardholderName') as string;\n\n    // Call PagSeguro tokenization API\n    const response = await fetch('https://api.pagseguro.com/public-keys/card', {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'Authorization': this.publicKey\n      },\n      body: JSON.stringify({\n        card: {\n          number: cardNumber,\n          exp_month: expMonth,\n          exp_year: `20${expYear}`,\n          security_code: cvv,\n          holder: {\n            name: cardholderName\n          }\n        }\n      })\n    });\n\n    if (!response.ok) {\n      throw new Error('Failed to tokenize card with PagSeguro');\n    }\n\n    const data = await response.json();\n    return data.encrypted;\n  }\n\n  async getInstallments(amount: number, bin: string): Promise<InstallmentOption[]> {\n    // PagSeguro installment calculation\n    // This would typically be done via your backend\n    const maxInstallments = 12;\n    const options: InstallmentOption[] = [];\n\n    for (let i = 1; i <= maxInstallments; i++) {\n      const interestFree = i <= 3;\n      const rate = interestFree ? 0 : 0.0199; // 1.99% per month\n      const totalAmount = interestFree ? amount : amount * Math.pow(1 + rate, i);\n      const installmentAmount = totalAmount / i;\n\n      if (installmentAmount >= 5) { // Minimum R$ 5 per installment\n        options.push({\n          installments: i,\n          installmentAmount: Math.round(installmentAmount * 100) / 100,\n          totalAmount: Math.round(totalAmount * 100) / 100,\n          interestFree,\n          interestRate: interestFree ? 0 : rate * 100,\n          recommended: i === 1\n        });\n      }\n    }\n\n    return options;\n  }\n\n  destroy(): void {\n    // Cleanup if needed\n  }\n}\n","/**\n * Client-side card data encryption using Web Crypto API.\n *\n * Uses hybrid encryption: RSA-OAEP (key wrapping) + AES-256-GCM (data encryption).\n * The Kairos backend decrypts with the merchant's RSA private key.\n *\n * Each merchant has its own RSA key pair stored in the database.\n *\n * Flow:\n * 1. Fetch merchant's RSA public key from Kairos tokenization endpoint\n * 2. Generate random AES-256 key\n * 3. Encrypt card JSON with AES-GCM\n * 4. Wrap AES key with RSA-OAEP public key\n * 5. Combine as base64 JSON envelope\n */\n\nexport interface CardDataToEncrypt {\n  number: string;\n  holderName: string;\n  expirationMonth: string;\n  expirationYear: string;\n  cvv: string;\n}\n\n// Cache public keys per merchant (keyed by merchantId)\nconst keyCache = new Map<string, { key: CryptoKey; timestamp: number }>();\nconst CACHE_TTL = 24 * 60 * 60 * 1000; // 24 hours (keys are persisted in DB per merchant)\n\n/**\n * Fetch the RSA public key for a specific merchant from the Kairos tokenization endpoint.\n * Cached per merchant for 24 hours.\n */\nasync function fetchPublicKey(apiUrl: string, tenantId: string, merchantId?: string): Promise<CryptoKey> {\n  const cacheKey = merchantId || '__default__';\n  const now = Date.now();\n  const cached = keyCache.get(cacheKey);\n  if (cached && now - cached.timestamp < CACHE_TTL) {\n    return cached.key;\n  }\n\n  const params = merchantId ? `?merchantId=${merchantId}` : '';\n  const res = await fetch(\n    `${apiUrl}/api/v1/tokenization/${tenantId}/encryption-key${params}`\n  );\n  if (!res.ok) {\n    throw new Error(`Failed to fetch encryption key: ${res.status}`);\n  }\n\n  const data = await res.json();\n  const publicKeyBase64: string = data.publicKey;\n\n  // Decode base64 -> ArrayBuffer\n  const binaryString = atob(publicKeyBase64);\n  const bytes = new Uint8Array(binaryString.length);\n  for (let i = 0; i < binaryString.length; i++) {\n    bytes[i] = binaryString.charCodeAt(i);\n  }\n\n  // Import as RSA-OAEP public key (SPKI format)\n  const cryptoKey = await crypto.subtle.importKey(\n    'spki',\n    bytes.buffer,\n    { name: 'RSA-OAEP', hash: 'SHA-256' },\n    false,\n    ['wrapKey']\n  );\n  keyCache.set(cacheKey, { key: cryptoKey, timestamp: now });\n\n  return cryptoKey;\n}\n\n/**\n * Encrypt card data for secure transmission to the backend.\n *\n * @param cardData Raw card fields\n * @param apiUrl Kairos API base URL\n * @param tenantId Tenant identifier\n * @param merchantId Merchant UUID (each merchant has its own RSA key pair)\n * @returns Base64-encoded encrypted envelope\n */\nexport async function encryptCardData(\n  cardData: CardDataToEncrypt,\n  apiUrl: string,\n  tenantId: string,\n  merchantId?: string\n): Promise<string> {\n  const rsaKey = await fetchPublicKey(apiUrl, tenantId, merchantId);\n\n  // Compact JSON with short keys to minimize payload\n  const cardJson = JSON.stringify({\n    n: cardData.number,\n    h: cardData.holderName,\n    m: cardData.expirationMonth,\n    y: cardData.expirationYear,\n    c: cardData.cvv,\n  });\n\n  const encoder = new TextEncoder();\n  const plaintext = encoder.encode(cardJson);\n\n  // Generate random AES-256 key\n  const aesKey = await crypto.subtle.generateKey(\n    { name: 'AES-GCM', length: 256 },\n    true, // extractable (needed for RSA wrapping)\n    ['encrypt']\n  );\n\n  // Generate random 12-byte IV for AES-GCM\n  const iv = crypto.getRandomValues(new Uint8Array(12));\n\n  // Encrypt card data with AES-GCM\n  const ciphertext = await crypto.subtle.encrypt(\n    { name: 'AES-GCM', iv, tagLength: 128 },\n    aesKey,\n    plaintext\n  );\n\n  // Wrap (encrypt) the AES key with RSA-OAEP\n  const wrappedKey = await crypto.subtle.wrapKey(\n    'raw',\n    aesKey,\n    rsaKey,\n    { name: 'RSA-OAEP' }\n  );\n\n  // Build envelope JSON and base64 encode\n  const envelope = JSON.stringify({\n    ek: arrayBufferToBase64(wrappedKey),   // encrypted key\n    iv: arrayBufferToBase64(iv.buffer),     // initialization vector\n    d: arrayBufferToBase64(ciphertext),     // encrypted data (includes GCM auth tag)\n  });\n\n  return btoa(envelope);\n}\n\n/**\n * Check if card encryption is available for a merchant (endpoint reachable).\n */\nexport async function isEncryptionAvailable(apiUrl: string, tenantId: string, merchantId?: string): Promise<boolean> {\n  try {\n    await fetchPublicKey(apiUrl, tenantId, merchantId);\n    return true;\n  } catch {\n    return false;\n  }\n}\n\n/**\n * Clear the cached public key for a specific merchant, or all if no merchantId.\n */\nexport function clearEncryptionCache(merchantId?: string): void {\n  if (merchantId) {\n    keyCache.delete(merchantId);\n  } else {\n    keyCache.clear();\n  }\n}\n\nfunction arrayBufferToBase64(buffer: ArrayBuffer): string {\n  const bytes = new Uint8Array(buffer);\n  let binary = '';\n  for (let i = 0; i < bytes.length; i++) {\n    binary += String.fromCharCode(bytes[i]);\n  }\n  return btoa(binary);\n}\n","import type {\n  PspAdapter,\n  CardPaymentConfig,\n  CardPaymentInstance,\n  InstallmentOption,\n  PaymentData\n} from '../types';\nimport { encryptCardData } from '../crypto/encryption';\n\n/**\n * Kairos Encrypted Adapter\n *\n * Renders a native card payment form and encrypts card data client-side\n * using RSA-OAEP + AES-256-GCM before transmission.\n *\n * Used as fallback when no PSP with client-side tokenization is available\n * (e.g., Asaas), or when the tenant explicitly prefers Kairos encryption.\n *\n * Card data never leaves the browser unencrypted.\n *\n * Styling: Uses CSS custom properties (--kairos-*) so host apps can override\n * colors, fonts, and borders. Falls back to sensible defaults and inherits\n * font-family from the parent element.\n */\nexport class KairosEncryptedAdapter implements PspAdapter {\n  readonly provider = 'KAIROS';\n\n  private apiUrl: string = '';\n  private tenantId: string = '';\n  private merchantId: string = '';\n\n  async init(_publicKey: string, options?: Record<string, unknown>): Promise<void> {\n    this.apiUrl = (options?.apiUrl as string) || 'https://api.kairoshub.tech';\n    this.tenantId = (options?.tenantId as string) || '';\n    this.merchantId = (options?.merchantId as string) || '';\n  }\n\n  async createCardPayment(\n    container: string | HTMLElement,\n    config: CardPaymentConfig\n  ): Promise<CardPaymentInstance> {\n    const containerEl = typeof container === 'string'\n      ? document.querySelector(container)\n      : container;\n\n    if (!containerEl) {\n      throw new Error(`Container not found: ${container}`);\n    }\n\n    // Inject styles + form HTML\n    containerEl.innerHTML = this.buildFormHtml(config);\n\n    const form = containerEl.querySelector('[data-kairos-enc-form]') as HTMLFormElement;\n    const errorEl = containerEl.querySelector('[data-kairos-enc-error]') as HTMLElement;\n    const submitBtn = containerEl.querySelector('[data-kairos-enc-submit]') as HTMLButtonElement;\n    const cardNumberInput = containerEl.querySelector('[data-kairos-enc-card-number]') as HTMLInputElement;\n    const expiryInput = containerEl.querySelector('[data-kairos-enc-expiry]') as HTMLInputElement;\n    const cvvInput = containerEl.querySelector('[data-kairos-enc-cvv]') as HTMLInputElement;\n    const nameInput = containerEl.querySelector('[data-kairos-enc-name]') as HTMLInputElement;\n    const installmentsSelect = containerEl.querySelector('[data-kairos-enc-installments]') as HTMLSelectElement;\n    const brandBadge = containerEl.querySelector('[data-kairos-enc-brand]') as HTMLElement;\n\n    // Card number formatting\n    cardNumberInput.addEventListener('input', () => {\n      const digits = cardNumberInput.value.replace(/\\D/g, '').slice(0, 16);\n      cardNumberInput.value = digits.replace(/(\\d{4})(?=\\d)/g, '$1 ');\n      // Detect brand\n      const brand = detectCardBrand(digits);\n      if (brandBadge) {\n        brandBadge.textContent = brand ? brand.toUpperCase() : '';\n        brandBadge.style.display = brand ? 'block' : 'none';\n      }\n    });\n\n    // Expiry formatting\n    expiryInput.addEventListener('input', () => {\n      const digits = expiryInput.value.replace(/\\D/g, '').slice(0, 4);\n      if (digits.length >= 3) {\n        expiryInput.value = `${digits.slice(0, 2)}/${digits.slice(2)}`;\n      } else {\n        expiryInput.value = digits;\n      }\n    });\n\n    // CVV: digits only\n    cvvInput.addEventListener('input', () => {\n      cvvInput.value = cvvInput.value.replace(/\\D/g, '').slice(0, 3);\n    });\n\n    // Name: uppercase\n    nameInput.addEventListener('input', () => {\n      nameInput.value = nameInput.value.toUpperCase();\n    });\n\n    // Load installments\n    if (installmentsSelect) {\n      const installments = await this.getInstallments(config.amount, '');\n      const limited = installments.filter(o => o.installments <= (config.maxInstallments || 12));\n      installmentsSelect.innerHTML = limited.map(opt => {\n        const amountStr = opt.installmentAmount.toFixed(2).replace('.', ',');\n        const suffix = opt.interestFree\n          ? ' sem juros'\n          : ` (Total: R$ ${opt.totalAmount.toFixed(2).replace('.', ',')})`;\n        return `<option value=\"${opt.installments}\">${opt.installments}x de R$ ${amountStr}${suffix}</option>`;\n      }).join('');\n    }\n\n    // Submit handler\n    form.addEventListener('submit', async (e) => {\n      e.preventDefault();\n      if (submitBtn.disabled) return;\n\n      // Validate\n      const validationError = this.validate(cardNumberInput.value, expiryInput.value, cvvInput.value, nameInput.value);\n      if (validationError) {\n        errorEl.textContent = validationError;\n        errorEl.style.display = 'block';\n        config.onError?.({ code: 'VALIDATION_ERROR', message: validationError });\n        return;\n      }\n\n      errorEl.style.display = 'none';\n      submitBtn.disabled = true;\n      const originalText = submitBtn.innerHTML;\n      submitBtn.innerHTML = this.getLoadingButtonHtml();\n\n      try {\n        const cleanNumber = cardNumberInput.value.replace(/\\D/g, '');\n        const [mm, yy] = expiryInput.value.split('/');\n        const expirationYear = (2000 + parseInt(yy || '0', 10)).toString();\n\n        // Encrypt card data client-side\n        const encrypted = await encryptCardData(\n          {\n            number: cleanNumber,\n            holderName: nameInput.value.trim(),\n            expirationMonth: mm,\n            expirationYear,\n            cvv: cvvInput.value,\n          },\n          this.apiUrl,\n          this.tenantId,\n          this.merchantId\n        );\n\n        const paymentData: PaymentData = {\n          token: '',\n          encryptedData: encrypted,\n          installments: installmentsSelect ? parseInt(installmentsSelect.value) : 1,\n          paymentMethodId: detectCardBrand(cleanNumber) || 'unknown',\n          issuerId: '',\n          lastFourDigits: cleanNumber.slice(-4),\n          cardholderName: nameInput.value.trim(),\n          provider: this.provider,\n        };\n\n        await config.onSubmit(paymentData);\n      } catch (err: any) {\n        errorEl.textContent = err.message || 'Erro ao processar pagamento';\n        errorEl.style.display = 'block';\n        config.onError?.({\n          code: 'ENCRYPTION_ERROR',\n          message: err.message || 'Failed to encrypt card data',\n          cause: err,\n        });\n      } finally {\n        submitBtn.disabled = false;\n        submitBtn.innerHTML = originalText;\n      }\n    });\n\n    config.onReady?.();\n\n    return {\n      updateAmount: (amount: number) => {\n        const amountEl = containerEl.querySelector('[data-kairos-enc-amount]');\n        if (amountEl) {\n          amountEl.textContent = `R$ ${amount.toFixed(2).replace('.', ',')}`;\n        }\n      },\n      submit: async () => {\n        form.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));\n        return {} as PaymentData;\n      },\n      unmount: () => {\n        containerEl.innerHTML = '';\n      },\n    };\n  }\n\n  async getInstallments(amount: number, _bin: string): Promise<InstallmentOption[]> {\n    const maxInstallments = 12;\n    const options: InstallmentOption[] = [];\n\n    for (let i = 1; i <= maxInstallments; i++) {\n      const interestFree = i <= 3;\n      const rate = interestFree ? 0 : 0.0199;\n      const totalAmount = interestFree ? amount : amount * Math.pow(1 + rate, i);\n      const installmentAmount = totalAmount / i;\n\n      if (installmentAmount >= 5) {\n        options.push({\n          installments: i,\n          installmentAmount: Math.round(installmentAmount * 100) / 100,\n          totalAmount: Math.round(totalAmount * 100) / 100,\n          interestFree,\n          interestRate: interestFree ? 0 : rate * 100,\n          recommended: i === 1,\n        });\n      }\n    }\n\n    return options;\n  }\n\n  destroy(): void {\n    // No external SDK to clean up\n  }\n\n  private validate(cardNumber: string, expiry: string, cvv: string, name: string): string | null {\n    const cleanNumber = cardNumber.replace(/\\D/g, '');\n    if (cleanNumber.length < 13) return 'Numero do cartao invalido';\n    if (expiry.length < 5) return 'Data de validade invalida';\n\n    const [mm, yy] = expiry.split('/');\n    const month = parseInt(mm, 10);\n    if (month < 1 || month > 12) return 'Mes invalido';\n\n    const year = 2000 + parseInt(yy || '0', 10);\n    const now = new Date();\n    if (year < now.getFullYear() || (year === now.getFullYear() && month < now.getMonth() + 1)) {\n      return 'Cartao expirado';\n    }\n\n    if (cvv.length !== 3) return 'CVV invalido';\n    if (name.trim().length < 3) return 'Nome invalido';\n    return null;\n  }\n\n  private getLoadingButtonHtml(): string {\n    return `\n      <svg class=\"kairos-enc-spinner\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n        <circle cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" stroke-width=\"3\" stroke-linecap=\"round\" stroke-dasharray=\"32\" stroke-dashoffset=\"32\">\n          <animate attributeName=\"stroke-dashoffset\" values=\"32;0;32\" dur=\"1.2s\" repeatCount=\"indefinite\"/>\n          <animateTransform attributeName=\"transform\" type=\"rotate\" from=\"0 12 12\" to=\"360 12 12\" dur=\"0.8s\" repeatCount=\"indefinite\"/>\n        </circle>\n      </svg>\n      <span>Criptografando...</span>\n    `;\n  }\n\n  private buildFormHtml(config: CardPaymentConfig): string {\n    const amountFormatted = config.amount.toFixed(2).replace('.', ',');\n\n    // Kairos brand logo SVG (matches console icon)\n    const kairosLogoSvg = `<svg width=\"18\" height=\"18\" viewBox=\"0 0 48 48\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n      <defs>\n        <linearGradient id=\"kairos-logo-grad\" x1=\"0%\" y1=\"0%\" x2=\"100%\" y2=\"100%\">\n          <stop offset=\"0%\" style=\"stop-color:#3B82F6\"/>\n          <stop offset=\"100%\" style=\"stop-color:#8B5CF6\"/>\n        </linearGradient>\n      </defs>\n      <circle cx=\"24\" cy=\"24\" r=\"22\" fill=\"url(#kairos-logo-grad)\"/>\n      <path d=\"M16 12 L16 36 M16 24 L32 12 M16 24 L32 36\" stroke=\"white\" stroke-width=\"4\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>\n      <circle cx=\"36\" cy=\"36\" r=\"5\" fill=\"#10B981\"/>\n    </svg>`;\n\n    return `\n      <style>\n        /*\n         * Kairos Payments SDK — Card Form Styles\n         *\n         * Override with CSS custom properties on the parent element:\n         *   --kairos-font:        Font family (default: inherit)\n         *   --kairos-text:        Text color (default: inherit)\n         *   --kairos-text-muted:  Muted text / labels (default: inherit with opacity)\n         *   --kairos-bg:          Input background (default: transparent)\n         *   --kairos-border:      Border color (default: currentColor with opacity)\n         *   --kairos-radius:      Border radius (default: 8px)\n         *   --kairos-focus:       Focus ring color (default: #7c3aed)\n         *   --kairos-accent:      Button gradient start (default: #7c3aed)\n         *   --kairos-accent-end:  Button gradient end (default: #9333ea)\n         *   --kairos-success:     Security badge color (default: #059669)\n         */\n        .kairos-enc-form {\n          font-family: var(--kairos-font, inherit);\n          color: var(--kairos-text, inherit);\n          display: flex;\n          flex-direction: column;\n          gap: 16px;\n        }\n        .kairos-enc-field {\n          display: flex;\n          flex-direction: column;\n          gap: 6px;\n        }\n        .kairos-enc-field label {\n          font-size: 13px;\n          font-weight: 500;\n          opacity: 0.7;\n        }\n        .kairos-enc-field input,\n        .kairos-enc-field select {\n          height: 44px;\n          padding: 0 12px;\n          border: 1px solid var(--kairos-border, color-mix(in srgb, currentColor 25%, transparent));\n          border-radius: var(--kairos-radius, 8px);\n          font-size: 15px;\n          font-family: inherit;\n          color: inherit;\n          background: var(--kairos-bg, transparent);\n          outline: none;\n          transition: border-color 0.15s, box-shadow 0.15s;\n          -webkit-appearance: none;\n        }\n        .kairos-enc-field input:focus,\n        .kairos-enc-field select:focus {\n          border-color: var(--kairos-focus, #7c3aed);\n          box-shadow: 0 0 0 3px color-mix(in srgb, var(--kairos-focus, #7c3aed) 15%, transparent);\n        }\n        .kairos-enc-field input::placeholder {\n          color: inherit;\n          opacity: 0.4;\n        }\n        .kairos-enc-row {\n          display: grid;\n          grid-template-columns: 1fr 1fr;\n          gap: 12px;\n        }\n        .kairos-enc-card-number-wrapper {\n          position: relative;\n        }\n        .kairos-enc-brand {\n          position: absolute;\n          right: 12px;\n          top: 50%;\n          transform: translateY(-50%);\n          font-size: 11px;\n          font-weight: 700;\n          opacity: 0.5;\n          letter-spacing: 0.05em;\n          display: none;\n        }\n        .kairos-enc-error {\n          display: none;\n          padding: 10px 14px;\n          background: color-mix(in srgb, #ef4444 10%, transparent);\n          border: 1px solid color-mix(in srgb, #ef4444 25%, transparent);\n          border-radius: var(--kairos-radius, 8px);\n          color: #ef4444;\n          font-size: 13px;\n        }\n        .kairos-enc-security {\n          display: flex;\n          align-items: center;\n          gap: 10px;\n          padding: 12px 14px;\n          background: color-mix(in srgb, var(--kairos-success, #059669) 8%, transparent);\n          border: 1px solid color-mix(in srgb, var(--kairos-success, #059669) 20%, transparent);\n          border-radius: var(--kairos-radius, 8px);\n        }\n        .kairos-enc-security-icon {\n          flex-shrink: 0;\n          width: 28px;\n          height: 28px;\n          color: var(--kairos-success, #059669);\n        }\n        .kairos-enc-security-text {\n          flex: 1;\n          min-width: 0;\n        }\n        .kairos-enc-security-text strong {\n          display: block;\n          font-size: 13px;\n          font-weight: 600;\n          color: var(--kairos-success, #059669);\n        }\n        .kairos-enc-security-text span {\n          font-size: 11px;\n          color: var(--kairos-success, #059669);\n          opacity: 0.75;\n        }\n        .kairos-enc-security-badge {\n          display: flex;\n          align-items: center;\n          gap: 5px;\n          flex-shrink: 0;\n          color: var(--kairos-success, #059669);\n          opacity: 0.85;\n        }\n        .kairos-enc-security-badge svg {\n          width: 18px;\n          height: 18px;\n        }\n        .kairos-enc-security-lock {\n          width: 10px;\n          height: 10px;\n          opacity: 0.7;\n        }\n        .kairos-enc-submit {\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          gap: 8px;\n          width: 100%;\n          height: 52px;\n          border: none;\n          border-radius: var(--kairos-radius, 8px);\n          font-size: 16px;\n          font-weight: 600;\n          font-family: inherit;\n          color: #fff;\n          background: linear-gradient(135deg, var(--kairos-accent, #7c3aed) 0%, var(--kairos-accent-end, #9333ea) 100%);\n          cursor: pointer;\n          transition: opacity 0.15s, transform 0.1s;\n        }\n        .kairos-enc-submit:hover:not(:disabled) {\n          opacity: 0.92;\n        }\n        .kairos-enc-submit:active:not(:disabled) {\n          transform: scale(0.98);\n        }\n        .kairos-enc-submit:disabled {\n          opacity: 0.6;\n          cursor: not-allowed;\n        }\n        .kairos-enc-submit svg {\n          width: 20px;\n          height: 20px;\n        }\n        .kairos-enc-spinner {\n          animation: kairos-enc-spin 0.8s linear infinite;\n        }\n        @keyframes kairos-enc-spin {\n          to { transform: rotate(360deg); }\n        }\n      </style>\n\n      <form class=\"kairos-enc-form\" data-kairos-enc-form>\n        <div data-kairos-enc-error class=\"kairos-enc-error\"></div>\n\n        <div class=\"kairos-enc-field\">\n          <label>Numero do Cartao</label>\n          <div class=\"kairos-enc-card-number-wrapper\">\n            <input\n              type=\"text\"\n              inputmode=\"numeric\"\n              placeholder=\"0000 0000 0000 0000\"\n              maxlength=\"19\"\n              autocomplete=\"cc-number\"\n              data-kairos-enc-card-number\n            />\n            <span class=\"kairos-enc-brand\" data-kairos-enc-brand></span>\n          </div>\n        </div>\n\n        <div class=\"kairos-enc-row\">\n          <div class=\"kairos-enc-field\">\n            <label>Validade</label>\n            <input\n              type=\"text\"\n              inputmode=\"numeric\"\n              placeholder=\"MM/AA\"\n              maxlength=\"5\"\n              autocomplete=\"cc-exp\"\n              data-kairos-enc-expiry\n            />\n          </div>\n          <div class=\"kairos-enc-field\">\n            <label>CVV</label>\n            <input\n              type=\"text\"\n              inputmode=\"numeric\"\n              placeholder=\"123\"\n              maxlength=\"3\"\n              autocomplete=\"cc-csc\"\n              data-kairos-enc-cvv\n            />\n          </div>\n        </div>\n\n        <div class=\"kairos-enc-field\">\n          <label>Nome no Cartao</label>\n          <input\n            type=\"text\"\n            placeholder=\"NOME COMO NO CARTAO\"\n            autocomplete=\"cc-name\"\n            data-kairos-enc-name\n          />\n        </div>\n\n        ${config.showInstallments !== false ? `\n        <div class=\"kairos-enc-field\">\n          <label>Parcelas</label>\n          <select data-kairos-enc-installments>\n            <option value=\"1\">1x de R$ ${amountFormatted} sem juros</option>\n          </select>\n        </div>\n        ` : ''}\n\n        <div class=\"kairos-enc-security\">\n          <svg class=\"kairos-enc-security-icon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\n            <path d=\"M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z\"/>\n            <path d=\"m9 12 2 2 4-4\"/>\n          </svg>\n          <div class=\"kairos-enc-security-text\">\n            <strong>Pagamento Seguro</strong>\n            <span>Criptografia ponta a ponta via Kairos Payment Hub</span>\n          </div>\n          <div class=\"kairos-enc-security-badge\">\n            <svg class=\"kairos-enc-security-lock\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2.5\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\n              <rect x=\"3\" y=\"11\" width=\"18\" height=\"11\" rx=\"2\" ry=\"2\"/>\n              <path d=\"M7 11V7a5 5 0 0 1 10 0v4\"/>\n            </svg>\n            ${kairosLogoSvg}\n          </div>\n        </div>\n\n        <button type=\"submit\" class=\"kairos-enc-submit\" data-kairos-enc-submit>\n          <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\n            <rect x=\"1\" y=\"4\" width=\"22\" height=\"16\" rx=\"2\" ry=\"2\"/>\n            <line x1=\"1\" y1=\"10\" x2=\"23\" y2=\"10\"/>\n          </svg>\n          <span>Pagar <span data-kairos-enc-amount>R$ ${amountFormatted}</span></span>\n        </button>\n      </form>\n    `;\n  }\n}\n\n/** Detect card brand from BIN (first digits). */\nfunction detectCardBrand(number: string): string {\n  const clean = number.replace(/\\D/g, '');\n  if (/^4/.test(clean)) return 'visa';\n  if (/^5[1-5]/.test(clean)) return 'mastercard';\n  if (/^3[47]/.test(clean)) return 'amex';\n  if (/^(636368|438935|504175|451416|636297)/.test(clean) || /^(5067|4576|4011)/.test(clean)) return 'elo';\n  if (/^606282/.test(clean)) return 'hipercard';\n  return '';\n}\n","import type {\n  KairosConfig,\n  CardPaymentConfig,\n  TokenizationOptions,\n  TokenizationOption,\n  InstallmentOption,\n  PspAdapter,\n  CardPaymentInstance\n} from '../types';\nimport { MercadoPagoAdapter } from '../adapters/MercadoPagoAdapter';\nimport { PagSeguroAdapter } from '../adapters/PagSeguroAdapter';\nimport { KairosEncryptedAdapter } from '../adapters/KairosEncryptedAdapter';\n\n/**\n * Main entry point for Kairos Payments SDK.\n *\n * @example\n * ```typescript\n * const kairos = await KairosPayments.init({\n *   tenantId: 'faithlink',\n *   environment: 'production'\n * });\n *\n * await kairos.createCardPayment('#card-form', {\n *   amount: 100.00,\n *   onSubmit: (data) => console.log(data.token)\n * });\n * ```\n */\nexport class KairosPayments {\n  private config: Required<KairosConfig>;\n  private options: TokenizationOption[] = [];\n  private adapter: PspAdapter | null = null;\n  private cardInstance: CardPaymentInstance | null = null;\n\n  private constructor(config: KairosConfig) {\n    this.config = {\n      tenantId: config.tenantId,\n      merchantId: config.merchantId || '',\n      environment: config.environment || 'production',\n      apiUrl: config.apiUrl || 'https://api.kairoshub.tech',\n      preferredProvider: config.preferredProvider || undefined as any,\n      locale: config.locale || 'pt-BR',\n      debug: config.debug || false\n    };\n  }\n\n  /**\n   * Initialize the Kairos Payments SDK.\n   * Fetches available PSPs and their public keys from the Kairos API.\n   */\n  static async init(config: KairosConfig): Promise<KairosPayments> {\n    const instance = new KairosPayments(config);\n    await instance.fetchOptions();\n    return instance;\n  }\n\n  /**\n   * Fetch tokenization options from Kairos API.\n   * Non-fatal: if no PSP options are available, KairosEncryptedAdapter is used as fallback.\n   */\n  private async fetchOptions(): Promise<void> {\n    const url = `${this.config.apiUrl}/api/v1/tokenization/${this.config.tenantId}/options`;\n\n    this.log('Fetching tokenization options from', url);\n\n    try {\n      const response = await fetch(url);\n\n      if (!response.ok) {\n        this.log('Failed to fetch tokenization options:', response.status);\n        this.options = [];\n        return;\n      }\n\n      const data: TokenizationOptions = await response.json();\n      this.options = data.options || [];\n\n      this.log('Available PSPs:', this.options.map(o => o.provider));\n    } catch (err) {\n      // Network error — Kairos encrypted adapter will be used as fallback\n      this.log('Error fetching tokenization options, will use Kairos encryption:', err);\n      this.options = [];\n    }\n  }\n\n  /**\n   * Get the best available PSP adapter.\n   *\n   * Selection priority:\n   * 1. If preferredProvider is 'KAIROS', use KairosEncryptedAdapter (our own encryption)\n   * 2. If preferredProvider matches a PSP option, use that PSP adapter\n   * 3. Use the first available PSP option\n   * 4. Fallback to KairosEncryptedAdapter when no PSP has client-side tokenization\n   */\n  private async getAdapter(): Promise<PspAdapter> {\n    if (this.adapter) {\n      return this.adapter;\n    }\n\n    // If KAIROS is explicitly preferred, use our encrypted adapter directly\n    if (this.config.preferredProvider === 'KAIROS') {\n      this.log('Using Kairos Encrypted adapter (preferred)');\n      return this.initKairosAdapter();\n    }\n\n    // Find preferred or first available PSP\n    let option = this.options[0];\n\n    if (this.config.preferredProvider) {\n      const preferred = this.options.find(\n        o => o.provider === this.config.preferredProvider\n      );\n      if (preferred) {\n        option = preferred;\n      }\n    }\n\n    // Fallback to Kairos encryption when no PSP with client-side tokenization\n    if (!option) {\n      this.log('No PSP with client-side tokenization available, falling back to Kairos encryption');\n      return this.initKairosAdapter();\n    }\n\n    this.log('Using PSP:', option.provider);\n\n    // Create adapter based on provider\n    switch (option.provider) {\n      case 'MERCADOPAGO':\n        this.adapter = new MercadoPagoAdapter();\n        break;\n      case 'PAGSEGURO':\n        this.adapter = new PagSeguroAdapter();\n        break;\n      default:\n        // Unknown PSP — try Kairos encrypted adapter as fallback\n        this.log(`Unknown PSP provider \"${option.provider}\", falling back to Kairos encryption`);\n        return this.initKairosAdapter();\n    }\n\n    // Initialize adapter with public key\n    await this.adapter.init(option.publicKey, {\n      locale: this.config.locale,\n      environment: option.environment\n    });\n\n    return this.adapter;\n  }\n\n  /**\n   * Initialize the Kairos Encrypted adapter (our own card form + encryption).\n   */\n  private async initKairosAdapter(): Promise<PspAdapter> {\n    this.adapter = new KairosEncryptedAdapter();\n    await this.adapter.init('', {\n      apiUrl: this.config.apiUrl,\n      tenantId: this.config.tenantId,\n      merchantId: this.config.merchantId,\n      locale: this.config.locale,\n    });\n    return this.adapter;\n  }\n\n  /**\n   * Create a card payment form.\n   *\n   * @param container - CSS selector or HTMLElement where the form will be mounted\n   * @param config - Payment configuration\n   * @returns Promise resolving to a CardPaymentInstance\n   */\n  async createCardPayment(\n    container: string | HTMLElement,\n    config: CardPaymentConfig\n  ): Promise<CardPaymentInstance> {\n    const adapter = await this.getAdapter();\n\n    this.log('Creating card payment form with amount:', config.amount);\n\n    this.cardInstance = await adapter.createCardPayment(container, config);\n    return this.cardInstance;\n  }\n\n  /**\n   * Get installment options for a given amount.\n   *\n   * @param amount - Payment amount in BRL\n   * @param bin - First 6 digits of the card number\n   * @returns Promise resolving to installment options\n   */\n  async getInstallments(amount: number, bin: string): Promise<InstallmentOption[]> {\n    const adapter = await this.getAdapter();\n    return adapter.getInstallments(amount, bin);\n  }\n\n  /**\n   * Get available PSP options for this tenant.\n   */\n  getAvailableProviders(): TokenizationOption[] {\n    return [...this.options];\n  }\n\n  /**\n   * Get current configuration.\n   */\n  getConfig(): Readonly<KairosConfig> {\n    return { ...this.config };\n  }\n\n  /**\n   * Destroy the SDK instance and cleanup resources.\n   */\n  destroy(): void {\n    if (this.cardInstance) {\n      this.cardInstance.unmount();\n      this.cardInstance = null;\n    }\n    if (this.adapter) {\n      this.adapter.destroy();\n      this.adapter = null;\n    }\n    this.options = [];\n  }\n\n  private log(...args: unknown[]): void {\n    if (this.config.debug) {\n      console.log('[Kairos]', ...args);\n    }\n  }\n}\n","/**\n * React component for card payment form.\n *\n * @example\n * ```tsx\n * import { CardPaymentForm } from '@kairos/payments-js';\n *\n * function Checkout() {\n *   return (\n *     <CardPaymentForm\n *       tenantId=\"faithlink\"\n *       amount={100.00}\n *       onSuccess={(data) => console.log('Token:', data.token)}\n *       onError={(error) => console.error(error)}\n *     />\n *   );\n * }\n * ```\n */\n\nimport { useEffect, useRef, useState } from 'react';\nimport { KairosPayments } from '../core/KairosPayments';\nimport type { CardPaymentConfig, PaymentData, PaymentError, KairosConfig } from '../types';\n\nexport interface CardPaymentFormProps {\n  /** Tenant identifier */\n  tenantId: string;\n\n  /** Payment amount in BRL */\n  amount: number;\n\n  /** Environment */\n  environment?: 'sandbox' | 'production';\n\n  /** API URL (optional) */\n  apiUrl?: string;\n\n  /** Preferred PSP provider */\n  preferredProvider?: 'MERCADOPAGO' | 'PAGSEGURO' | 'KAIROS';\n\n  /** Maximum installments */\n  maxInstallments?: number;\n\n  /** Callback on successful payment */\n  onSuccess: (data: PaymentData) => void;\n\n  /** Callback on error */\n  onError?: (error: PaymentError) => void;\n\n  /** Callback when form is ready */\n  onReady?: () => void;\n\n  /** Custom class name */\n  className?: string;\n\n  /** Debug mode */\n  debug?: boolean;\n}\n\nexport function CardPaymentForm({\n  tenantId,\n  amount,\n  environment = 'production',\n  apiUrl,\n  preferredProvider,\n  maxInstallments = 12,\n  onSuccess,\n  onError,\n  onReady,\n  className,\n  debug = false\n}: CardPaymentFormProps) {\n  const containerRef = useRef<HTMLDivElement>(null);\n  const kairosRef = useRef<KairosPayments | null>(null);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n\n  useEffect(() => {\n    let mounted = true;\n\n    async function initKairos() {\n      if (!containerRef.current) return;\n\n      try {\n        setLoading(true);\n        setError(null);\n\n        const config: KairosConfig = {\n          tenantId,\n          environment,\n          apiUrl,\n          preferredProvider,\n          debug\n        };\n\n        const kairos = await KairosPayments.init(config);\n\n        if (!mounted) {\n          kairos.destroy();\n          return;\n        }\n\n        kairosRef.current = kairos;\n\n        const paymentConfig: CardPaymentConfig = {\n          amount,\n          maxInstallments,\n          onReady: () => {\n            setLoading(false);\n            onReady?.();\n          },\n          onSubmit: async (data) => {\n            onSuccess(data);\n          },\n          onError: (err) => {\n            setError(err.message);\n            onError?.(err);\n          }\n        };\n\n        await kairos.createCardPayment(containerRef.current, paymentConfig);\n      } catch (err: any) {\n        if (mounted) {\n          const errorMessage = err.message || 'Failed to initialize payment form';\n          setError(errorMessage);\n          setLoading(false);\n          onError?.({\n            code: 'INIT_ERROR',\n            message: errorMessage,\n            cause: err\n          });\n        }\n      }\n    }\n\n    initKairos();\n\n    return () => {\n      mounted = false;\n      if (kairosRef.current) {\n        kairosRef.current.destroy();\n        kairosRef.current = null;\n      }\n    };\n  }, [tenantId, amount, environment, apiUrl, preferredProvider]);\n\n  return (\n    <div className={className}>\n      {loading && (\n        <div className=\"kairos-loading\">\n          <div className=\"kairos-spinner\" />\n          <span>Carregando formulario de pagamento...</span>\n        </div>\n      )}\n\n      {error && (\n        <div className=\"kairos-error\">\n          <span>{error}</span>\n        </div>\n      )}\n\n      <div\n        ref={containerRef}\n        id=\"kairos-card-payment-container\"\n        style={{ display: loading ? 'none' : 'block' }}\n      />\n\n      {!loading && !error && (\n        <div className=\"kairos-branding\" style={brandingStyles}>\n          <KairosLogo />\n          <span style={brandingTextStyle}>Powered by Kairos</span>\n        </div>\n      )}\n    </div>\n  );\n}\n\nconst brandingStyles: React.CSSProperties = {\n  display: 'flex',\n  alignItems: 'center',\n  justifyContent: 'center',\n  gap: '6px',\n  padding: '8px 0 4px',\n  opacity: 0.6,\n};\n\nconst brandingTextStyle: React.CSSProperties = {\n  fontSize: '11px',\n  fontFamily: '-apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, sans-serif',\n  color: '#6b7280',\n  letterSpacing: '0.02em',\n};\n\nfunction KairosLogo() {\n  return (\n    <svg width=\"14\" height=\"14\" viewBox=\"0 0 48 48\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n      <defs>\n        <linearGradient id=\"kairos-form-grad\" x1=\"0%\" y1=\"0%\" x2=\"100%\" y2=\"100%\">\n          <stop offset=\"0%\" stopColor=\"#3B82F6\"/>\n          <stop offset=\"100%\" stopColor=\"#8B5CF6\"/>\n        </linearGradient>\n      </defs>\n      <circle cx=\"24\" cy=\"24\" r=\"22\" fill=\"url(#kairos-form-grad)\"/>\n      <path d=\"M16 12 L16 36 M16 24 L32 12 M16 24 L32 36\" stroke=\"white\" strokeWidth=\"4\" strokeLinecap=\"round\" strokeLinejoin=\"round\"/>\n      <circle cx=\"36\" cy=\"36\" r=\"5\" fill=\"#10B981\"/>\n    </svg>\n  );\n}\n","/**\n * PaymentPoller - Polls a status endpoint until a terminal status is reached.\n *\n * The SDK doesn't call Kairos API directly (it has no auth tokens).\n * Instead, the integrator provides a `fetchStatus` function that calls their\n * own backend, which in turn proxies to the Kairos transaction status API.\n *\n * @example\n * ```typescript\n * import { PaymentPoller } from '@kairos/payments-js';\n *\n * const poller = new PaymentPoller({\n *   fetchStatus: async () => {\n *     const res = await fetch(`/api/payments/status/${transactionId}`);\n *     return res.json(); // { status: 'CONFIRMED', ... }\n *   },\n *   onStatusChange: (status, data) => {\n *     if (status === 'CONFIRMED') showSuccess();\n *   },\n *   intervalMs: 3000,\n *   timeoutMs: 300000, // 5 minutes\n * });\n *\n * poller.start();\n * // later: poller.stop();\n * ```\n */\n\nexport type PaymentStatus =\n  | 'PENDING'\n  | 'PROCESSING'\n  | 'AUTHORIZED'\n  | 'CONFIRMED'\n  | 'FAILED'\n  | 'CANCELLED'\n  | 'EXPIRED'\n  | 'REFUNDED'\n  | 'CHARGEBACK';\n\nconst TERMINAL_STATUSES: Set<string> = new Set([\n  'CONFIRMED',\n  'FAILED',\n  'CANCELLED',\n  'EXPIRED',\n  'REFUNDED',\n  'CHARGEBACK',\n]);\n\nexport interface PaymentStatusResponse {\n  status: string;\n  [key: string]: unknown;\n}\n\nexport interface PaymentPollerConfig {\n  /** Function that fetches the current payment status from your backend */\n  fetchStatus: () => Promise<PaymentStatusResponse>;\n\n  /** Called when status changes (including the first poll) */\n  onStatusChange?: (status: string, data: PaymentStatusResponse) => void;\n\n  /** Called when a terminal status is reached (CONFIRMED, FAILED, etc.) */\n  onComplete?: (status: string, data: PaymentStatusResponse) => void;\n\n  /** Called on fetch errors */\n  onError?: (error: unknown) => void;\n\n  /** Polling interval in milliseconds (default: 3000) */\n  intervalMs?: number;\n\n  /** Maximum polling duration in milliseconds (default: 300000 = 5 min) */\n  timeoutMs?: number;\n}\n\nexport class PaymentPoller {\n  private config: Required<PaymentPollerConfig>;\n  private timer: ReturnType<typeof setInterval> | null = null;\n  private timeoutTimer: ReturnType<typeof setTimeout> | null = null;\n  private lastStatus: string | null = null;\n  private running = false;\n\n  constructor(config: PaymentPollerConfig) {\n    this.config = {\n      fetchStatus: config.fetchStatus,\n      onStatusChange: config.onStatusChange || (() => {}),\n      onComplete: config.onComplete || (() => {}),\n      onError: config.onError || (() => {}),\n      intervalMs: config.intervalMs ?? 3000,\n      timeoutMs: config.timeoutMs ?? 300_000,\n    };\n  }\n\n  /** Start polling. Safe to call multiple times (no-op if already running). */\n  start(): void {\n    if (this.running) return;\n    this.running = true;\n    this.lastStatus = null;\n\n    // First poll immediately\n    this.poll();\n\n    // Then poll at interval\n    this.timer = setInterval(() => this.poll(), this.config.intervalMs);\n\n    // Auto-stop after timeout\n    this.timeoutTimer = setTimeout(() => {\n      this.stop();\n      this.config.onStatusChange('EXPIRED', { status: 'EXPIRED', reason: 'polling_timeout' });\n      this.config.onComplete('EXPIRED', { status: 'EXPIRED', reason: 'polling_timeout' });\n    }, this.config.timeoutMs);\n  }\n\n  /** Stop polling and clean up timers. */\n  stop(): void {\n    this.running = false;\n    if (this.timer) {\n      clearInterval(this.timer);\n      this.timer = null;\n    }\n    if (this.timeoutTimer) {\n      clearTimeout(this.timeoutTimer);\n      this.timeoutTimer = null;\n    }\n  }\n\n  /** Whether the poller is currently active. */\n  get isRunning(): boolean {\n    return this.running;\n  }\n\n  private async poll(): Promise<void> {\n    if (!this.running) return;\n\n    try {\n      const data = await this.config.fetchStatus();\n      const status = data.status?.toUpperCase() || 'PENDING';\n\n      if (status !== this.lastStatus) {\n        this.lastStatus = status;\n        this.config.onStatusChange(status, data);\n      }\n\n      if (TERMINAL_STATUSES.has(status)) {\n        this.stop();\n        this.config.onComplete(status, data);\n      }\n    } catch (error) {\n      this.config.onError(error);\n    }\n  }\n}\n","/**\n * Kairos Payments JavaScript SDK\n *\n * A unified SDK for card tokenization and payments across multiple PSPs.\n *\n * @example\n * ```typescript\n * import { KairosPayments } from '@kairos/payments-js';\n *\n * const kairos = await KairosPayments.init({\n *   tenantId: 'faithlink',\n *   environment: 'production'\n * });\n *\n * await kairos.createCardPayment('#container', {\n *   amount: 100.00,\n *   onSubmit: async (data) => {\n *     // Send data.token to your backend\n *   }\n * });\n * ```\n */\n\nexport { KairosPayments } from './core/KairosPayments';\nexport { CardPaymentForm } from './components/CardPaymentForm';\nexport { KairosEncryptedAdapter } from './adapters/KairosEncryptedAdapter';\n\n// Payment status polling\nexport { PaymentPoller } from './core/PaymentPoller';\nexport type { PaymentPollerConfig, PaymentStatusResponse, PaymentStatus } from './core/PaymentPoller';\n\n// Encryption utilities\nexport { encryptCardData, isEncryptionAvailable, clearEncryptionCache } from './crypto/encryption';\nexport type { CardDataToEncrypt } from './crypto/encryption';\n\n// Types\nexport type {\n  KairosConfig,\n  CardPaymentConfig,\n  PaymentData,\n  InstallmentOption,\n  TokenizationOptions,\n  PspAdapter\n} from './types';\n\n// Version\nexport const VERSION = '0.2.0';\n"],"names":["MercadoPagoAdapter","constructor","this","provider","mp","bricksBuilder","cardPaymentBrick","publicKey","loadScript","window","MercadoPago","Promise","resolve","reject","script","document","createElement","src","async","onload","onerror","Error","head","appendChild","init","options","locale","bricks","createCardPayment","container","config","containerId","replace","id","unmount","settings","initialization","amount","payer","email","customization","visual","style","customVariables","formBackgroundColor","styles","primaryColor","baseColor","paymentMethods","maxInstallments","callbacks","onReady","onSubmit","cardFormData","paymentData","token","installments","paymentMethodId","payment_method_id","issuerId","issuer_id","lastFourDigits","last_four_digits","cardholderName","cardholder","name","onError","error","code","type","message","cause","create","updateAmount","console","warn","submit","getInstallments","bin","response","String","length","payer_costs","map","cost","index","installmentAmount","installment_amount","totalAmount","total_amount","interestFree","installment_rate","interestRate","recommended","destroy","PagSeguroAdapter","environment","PagSeguro","scriptUrl","containerEl","querySelector","formHtml","createFormHtml","innerHTML","form","addEventListener","e","preventDefault","formData","FormData","tokenizeCard","parseInt","get","slice","amountEl","textContent","toFixed","dispatchEvent","Event","showInstallments","cardNumber","expMonth","expYear","split","cvv","fetch","method","headers","Authorization","body","JSON","stringify","card","number","exp_month","exp_year","security_code","holder","ok","json","encrypted","i","rate","Math","pow","push","round","keyCache","Map","fetchPublicKey","apiUrl","tenantId","merchantId","cacheKey","now","Date","cached","timestamp","key","params","res","status","publicKeyBase64","binaryString","atob","bytes","Uint8Array","charCodeAt","cryptoKey","crypto","subtle","importKey","buffer","hash","set","encryptCardData","cardData","rsaKey","cardJson","n","h","holderName","m","expirationMonth","y","expirationYear","c","plaintext","TextEncoder","encode","aesKey","generateKey","iv","getRandomValues","ciphertext","encrypt","tagLength","wrappedKey","wrapKey","envelope","ek","arrayBufferToBase64","d","btoa","binary","fromCharCode","KairosEncryptedAdapter","_publicKey","buildFormHtml","errorEl","submitBtn","cardNumberInput","expiryInput","cvvInput","nameInput","installmentsSelect","brandBadge","digits","value","brand","detectCardBrand","toUpperCase","display","limited","filter","o","opt","amountStr","suffix","join","disabled","validationError","validate","originalText","getLoadingButtonHtml","cleanNumber","mm","yy","toString","encryptedData","trim","err","bubbles","cancelable","_bin","expiry","month","year","getFullYear","getMonth","amountFormatted","clean","test","KairosPayments","adapter","cardInstance","preferredProvider","undefined","debug","instance","fetchOptions","url","log","data","getAdapter","initKairosAdapter","option","preferred","find","getAvailableProviders","getConfig","args","brandingStyles","alignItems","justifyContent","gap","padding","opacity","brandingTextStyle","fontSize","fontFamily","color","letterSpacing","KairosLogo","_jsxs","width","height","viewBox","fill","xmlns","children","_jsx","x1","y1","x2","y2","offset","stopColor","cx","cy","r","stroke","strokeWidth","strokeLinecap","strokeLinejoin","TERMINAL_STATUSES","Set","onSuccess","className","containerRef","useRef","kairosRef","loading","setLoading","useState","setError","useEffect","mounted","current","kairos","paymentConfig","errorMessage","initKairos","ref","timer","timeoutTimer","lastStatus","running","fetchStatus","onStatusChange","onComplete","intervalMs","timeoutMs","start","poll","setInterval","setTimeout","stop","reason","clearInterval","clearTimeout","isRunning","has","delete","clear"],"mappings":"sVAoBaA,EAAb,WAAAC,GACWC,KAAAC,SAAW,cAEZD,KAAAE,GAAU,KACVF,KAAAG,cAAqB,KACrBH,KAAAI,iBAAwB,KACxBJ,KAAAK,UAAoB,EAiJ9B,CA5IU,gBAAMC,GACZ,IAAIC,OAAOC,YAIX,OAAO,IAAIC,QAAQ,CAACC,EAASC,KAC3B,MAAMC,EAASC,SAASC,cAAc,UACtCF,EAAOG,IAAM,oCACbH,EAAOI,OAAQ,EACfJ,EAAOK,OAAS,IAAMP,IACtBE,EAAOM,QAAU,IAAMP,EAAO,IAAIQ,MAAM,mCACxCN,SAASO,KAAKC,YAAYT,IAE9B,CAEA,UAAMU,CAAKjB,EAAmBkB,GAC5BvB,KAAKK,UAAYA,QAEXL,KAAKM,aAEXN,KAAKE,GAAK,IAAIK,OAAOC,YAAYH,EAAW,CAC1CmB,OAAQD,GAASC,QAAU,UAG7BxB,KAAKG,cAAgBH,KAAKE,GAAGuB,QAC/B,CAEA,uBAAMC,CACJC,EACAC,GAEA,MAAMC,EAAmC,iBAAdF,EACvBA,EAAUG,QAAQ,IAAK,IACvBH,EAAUI,GAGV/B,KAAKI,wBACDJ,KAAKI,iBAAiB4B,UAG9B,MAAMC,EAAW,CACfC,eAAgB,CACdC,OAAQP,EAAOO,OACfC,MAAO,CACLC,MAAO,KAGXC,cAAe,CACbC,OAAQ,CACNC,MAAO,CACLC,gBAAiB,CACfC,oBAAqBd,EAAOe,QAAQC,cAAgB,UACpDC,UAAWjB,EAAOe,QAAQC,cAAgB,aAIhDE,eAAgB,CACdC,gBAAiBnB,EAAOmB,iBAAmB,KAG/CC,UAAW,CACTC,QAAS,KACPrB,EAAOqB,aAETC,SAAUlC,MAAOmC,IACf,MAAMC,EAA2B,CAC/BC,MAAOF,EAAaE,MACpBC,aAAcH,EAAaG,aAC3BC,gBAAiBJ,EAAaK,kBAC9BC,SAAUN,EAAaO,UACvBC,eAAgBR,EAAaS,kBAAoB,GACjDC,eAAgBV,EAAaW,YAAYC,MAAQ,GACjD9D,SAAUD,KAAKC,gBAGX2B,EAAOsB,SAASE,IAExBY,QAAUC,IACRrC,EAAOoC,UAAU,CACfE,KAAMD,EAAME,MAAQ,UACpBC,QAASH,EAAMG,SAAW,oBAC1BC,MAAOJ,OAYf,OANAjE,KAAKI,uBAAyBJ,KAAKG,cAAcmE,OAC/C,cACAzC,EACAI,GAGK,CACLsC,aAAepC,IAGbqC,QAAQC,KAAK,8DAEfC,OAAQ1D,UAEN,MAAM,IAAIG,MAAM,gCAElBa,QAAS,KACPhC,KAAKI,kBAAkB4B,UACvBhC,KAAKI,iBAAmB,MAG9B,CAEA,qBAAMuE,CAAgBxC,EAAgByC,GACpC,MAAMC,QAAiB7E,KAAKE,GAAGyE,gBAAgB,CAC7CxC,OAAQ2C,OAAO3C,GACfyC,IAAKA,IAGP,IAAKC,GAAgC,IAApBA,EAASE,OACxB,MAAO,GAKT,OAFmBF,EAAS,GAAGG,aAAe,IAE5BC,IAAI,CAACC,EAAWC,KAAa,CAC7C7B,aAAc4B,EAAK5B,aACnB8B,kBAAmBF,EAAKG,mBACxBC,YAAaJ,EAAKK,aAClBC,aAAwC,IAA1BN,EAAKO,iBACnBC,aAAcR,EAAKO,iBACnBE,YAAuB,IAAVR,IAEjB,CAEA,OAAAS,GACM5F,KAAKI,mBACPJ,KAAKI,iBAAiB4B,UACtBhC,KAAKI,iBAAmB,MAE1BJ,KAAKE,GAAK,KACVF,KAAKG,cAAgB,IACvB,QCvJW0F,EAAb,WAAA9F,GACWC,KAAAC,SAAW,YAEZD,KAAAK,UAAoB,GACpBL,KAAA8F,YAAsB,SAkNhC,CA7MU,gBAAMxF,GACZ,GAAIC,OAAOwF,UACT,OAGF,MAAMC,EAAiC,eAArBhG,KAAK8F,YACnB,mFACA,gGAEJ,OAAO,IAAIrF,QAAQ,CAACC,EAASC,KAC3B,MAAMC,EAASC,SAASC,cAAc,UACtCF,EAAOG,IAAMiF,EACbpF,EAAOI,OAAQ,EACfJ,EAAOK,OAAS,IAAMP,IACtBE,EAAOM,QAAU,IAAMP,EAAO,IAAIQ,MAAM,iCACxCN,SAASO,KAAKC,YAAYT,IAE9B,CAEA,UAAMU,CAAKjB,EAAmBkB,GAC5BvB,KAAKK,UAAYA,EACjBL,KAAK8F,YAAevE,GAASuE,aAA0B,gBAEjD9F,KAAKM,YAIb,CAEA,uBAAMoB,CACJC,EACAC,GAEA,MAAMqE,EAAmC,iBAAdtE,EACvBd,SAASqF,cAAcvE,GACvBA,EAEJ,IAAKsE,EACH,MAAM,IAAI9E,MAAM,wBAAwBQ,KAK1C,MAAMwE,EAAWnG,KAAKoG,eAAexE,GACrCqE,EAAYI,UAAYF,EAExB,MAAMG,EAAOL,EAAYC,cAAc,QA+BvC,OA7BAI,EAAKC,iBAAiB,SAAUvF,MAAOwF,IACrCA,EAAEC,iBAEF,IACE,MAAMC,EAAW,IAAIC,SAASL,GAGxBlD,EAA2B,CAC/BC,YAHkBrD,KAAK4G,aAAaF,GAIpCpD,aAAcuD,SAASH,EAASI,IAAI,kBAA8B,EAClEvD,gBAAiB,cACjBE,SAAU,GACVE,eAAiB+C,EAASI,IAAI,eAA0BC,OAAO,IAAM,GACrElD,eAAgB6C,EAASI,IAAI,mBAA+B,GAC5D7G,SAAUD,KAAKC,gBAGX2B,EAAOsB,SAASE,EACxB,CAAE,MAAOa,GACPrC,EAAOoC,UAAU,CACfE,KAAM,qBACNE,QAASH,EAAMG,SAAW,0BAC1BC,MAAOJ,GAEX,IAGFrC,EAAOqB,YAEA,CACLsB,aAAepC,IACb,MAAM6E,EAAWV,EAAKJ,cAAc,iBAChCc,IACFA,EAASC,YAAc,MAAM9E,EAAO+E,QAAQ,OAGhDxC,OAAQ1D,UACNsF,EAAKa,cAAc,IAAIC,MAAM,WACtB,IAETpF,QAAS,KACPiE,EAAYI,UAAY,IAG9B,CAEQ,cAAAD,CAAexE,GACrB,MAAO,2kCA4B2B,IAA5BA,EAAOyF,iBAA6B,gMAILzF,EAAOO,OAAO+E,QAAQ,6DAGnD,wGAG2BtF,EAAOO,OAAO+E,QAAQ,mDAI3D,CAEQ,kBAAMN,CAAaF,GAGzB,MAAMY,EAAcZ,EAASI,IAAI,eAA0BhF,QAAQ,MAAO,KACnEyF,EAAUC,GAAYd,EAASI,IAAI,WAAsBW,MAAM,MAAQ,GACxEC,EAAMhB,EAASI,IAAI,OACnBjD,EAAiB6C,EAASI,IAAI,kBAG9BjC,QAAiB8C,MAAM,6CAA8C,CACzEC,OAAQ,OACRC,QAAS,CACP,eAAgB,mBAChBC,cAAiB9H,KAAKK,WAExB0H,KAAMC,KAAKC,UAAU,CACnBC,KAAM,CACJC,OAAQb,EACRc,UAAWb,EACXc,SAAU,KAAKb,IACfc,cAAeZ,EACfa,OAAQ,CACNxE,KAAMF,QAMd,IAAKgB,EAAS2D,GACZ,MAAM,IAAIrH,MAAM,0CAIlB,aADmB0D,EAAS4D,QAChBC,SACd,CAEA,qBAAM/D,CAAgBxC,EAAgByC,GAGpC,MACMrD,EAA+B,GAErC,IAAK,IAAIoH,EAAI,EAAGA,GAHQ,GAGcA,IAAK,CACzC,MAAMnD,EAAemD,GAAK,EACpBC,EAAOpD,EAAe,EAAI,MAC1BF,EAAcE,EAAerD,EAASA,EAAS0G,KAAKC,IAAI,EAAIF,EAAMD,GAClEvD,EAAoBE,EAAcqD,EAEpCvD,GAAqB,GACvB7D,EAAQwH,KAAK,CACXzF,aAAcqF,EACdvD,kBAAmByD,KAAKG,MAA0B,IAApB5D,GAA2B,IACzDE,YAAauD,KAAKG,MAAoB,IAAd1D,GAAqB,IAC7CE,eACAE,aAAcF,EAAe,EAAW,IAAPoD,EACjCjD,YAAmB,IAANgD,GAGnB,CAEA,OAAOpH,CACT,CAEA,OAAAqE,GAEA,EC/MF,MAAMqD,EAAW,IAAIC,IAOrBlI,eAAemI,EAAeC,EAAgBC,EAAkBC,GAC9D,MAAMC,EAAWD,GAAc,cACzBE,EAAMC,KAAKD,MACXE,EAAST,EAASnC,IAAIyC,GAC5B,GAAIG,GAAUF,EAAME,EAAOC,UAVX,MAWd,OAAOD,EAAOE,IAGhB,MAAMC,EAASP,EAAa,eAAeA,IAAe,GACpDQ,QAAYnC,MAChB,GAAGyB,yBAA8BC,mBAA0BQ,KAE7D,IAAKC,EAAItB,GACP,MAAM,IAAIrH,MAAM,mCAAmC2I,EAAIC,UAGzD,MACMC,SADaF,EAAIrB,QACcpI,UAG/B4J,EAAeC,KAAKF,GACpBG,EAAQ,IAAIC,WAAWH,EAAalF,QAC1C,IAAK,IAAI4D,EAAI,EAAGA,EAAIsB,EAAalF,OAAQ4D,IACvCwB,EAAMxB,GAAKsB,EAAaI,WAAW1B,GAIrC,MAAM2B,QAAkBC,OAAOC,OAAOC,UACpC,OACAN,EAAMO,OACN,CAAE3G,KAAM,WAAY4G,KAAM,YAC1B,EACA,CAAC,YAIH,OAFA1B,EAAS2B,IAAIrB,EAAU,CAAEK,IAAKU,EAAWX,UAAWH,IAE7Cc,CACT,CAWOtJ,eAAe6J,EACpBC,EACA1B,EACAC,EACAC,GAEA,MAAMyB,QAAe5B,EAAeC,EAAQC,EAAUC,GAGhD0B,EAAWhD,KAAKC,UAAU,CAC9BgD,EAAGH,EAAS3C,OACZ+C,EAAGJ,EAASK,WACZC,EAAGN,EAASO,gBACZC,EAAGR,EAASS,eACZC,EAAGV,EAASpD,MAIR+D,GADU,IAAIC,aACMC,OAAOX,GAG3BY,QAAerB,OAAOC,OAAOqB,YACjC,CAAE9H,KAAM,UAAWgB,OAAQ,MAC3B,EACA,CAAC,YAIG+G,EAAKvB,OAAOwB,gBAAgB,IAAI3B,WAAW,KAG3C4B,QAAmBzB,OAAOC,OAAOyB,QACrC,CAAElI,KAAM,UAAW+H,KAAII,UAAW,KAClCN,EACAH,GAIIU,QAAmB5B,OAAOC,OAAO4B,QACrC,MACAR,EACAb,EACA,CAAEhH,KAAM,aAIJsI,EAAWrE,KAAKC,UAAU,CAC9BqE,GAAIC,EAAoBJ,GACxBL,GAAIS,EAAoBT,EAAGpB,QAC3B8B,EAAGD,EAAoBP,KAGzB,OAAOS,KAAKJ,EACd,CAyBA,SAASE,EAAoB7B,GAC3B,MAAMP,EAAQ,IAAIC,WAAWM,GAC7B,IAAIgC,EAAS,GACb,IAAK,IAAI/D,EAAI,EAAGA,EAAIwB,EAAMpF,OAAQ4D,IAChC+D,GAAU5H,OAAO6H,aAAaxC,EAAMxB,IAEtC,OAAO8D,KAAKC,EACd,OC7IaE,EAAb,WAAA7M,GACWC,KAAAC,SAAW,SAEZD,KAAAoJ,OAAiB,GACjBpJ,KAAAqJ,SAAmB,GACnBrJ,KAAAsJ,WAAqB,EAmf/B,CAjfE,UAAMhI,CAAKuL,EAAoBtL,GAC7BvB,KAAKoJ,OAAU7H,GAAS6H,QAAqB,6BAC7CpJ,KAAKqJ,SAAY9H,GAAS8H,UAAuB,GACjDrJ,KAAKsJ,WAAc/H,GAAS+H,YAAyB,EACvD,CAEA,uBAAM5H,CACJC,EACAC,GAEA,MAAMqE,EAAmC,iBAAdtE,EACvBd,SAASqF,cAAcvE,GACvBA,EAEJ,IAAKsE,EACH,MAAM,IAAI9E,MAAM,wBAAwBQ,KAI1CsE,EAAYI,UAAYrG,KAAK8M,cAAclL,GAE3C,MAAM0E,EAAOL,EAAYC,cAAc,0BACjC6G,EAAU9G,EAAYC,cAAc,2BACpC8G,EAAY/G,EAAYC,cAAc,4BACtC+G,EAAkBhH,EAAYC,cAAc,iCAC5CgH,EAAcjH,EAAYC,cAAc,4BACxCiH,EAAWlH,EAAYC,cAAc,yBACrCkH,EAAYnH,EAAYC,cAAc,0BACtCmH,EAAqBpH,EAAYC,cAAc,kCAC/CoH,EAAarH,EAAYC,cAAc,2BAmC7C,GAhCA+G,EAAgB1G,iBAAiB,QAAS,KACxC,MAAMgH,EAASN,EAAgBO,MAAM1L,QAAQ,MAAO,IAAIiF,MAAM,EAAG,IACjEkG,EAAgBO,MAAQD,EAAOzL,QAAQ,iBAAkB,OAEzD,MAAM2L,EAAQC,EAAgBH,GAC1BD,IACFA,EAAWrG,YAAcwG,EAAQA,EAAME,cAAgB,GACvDL,EAAW9K,MAAMoL,QAAUH,EAAQ,QAAU,UAKjDP,EAAY3G,iBAAiB,QAAS,KACpC,MAAMgH,EAASL,EAAYM,MAAM1L,QAAQ,MAAO,IAAIiF,MAAM,EAAG,GACzDwG,EAAOxI,QAAU,EACnBmI,EAAYM,MAAQ,GAAGD,EAAOxG,MAAM,EAAG,MAAMwG,EAAOxG,MAAM,KAE1DmG,EAAYM,MAAQD,IAKxBJ,EAAS5G,iBAAiB,QAAS,KACjC4G,EAASK,MAAQL,EAASK,MAAM1L,QAAQ,MAAO,IAAIiF,MAAM,EAAG,KAI9DqG,EAAU7G,iBAAiB,QAAS,KAClC6G,EAAUI,MAAQJ,EAAUI,MAAMG,gBAIhCN,EAAoB,CACtB,MACMQ,SADqB7N,KAAK2E,gBAAgB/C,EAAOO,OAAQ,KAClC2L,OAAOC,GAAKA,EAAEzK,eAAiB1B,EAAOmB,iBAAmB,KACtFsK,EAAmBhH,UAAYwH,EAAQ5I,IAAI+I,IACzC,MAAMC,EAAYD,EAAI5I,kBAAkB8B,QAAQ,GAAGpF,QAAQ,IAAK,KAC1DoM,EAASF,EAAIxI,aACf,aACA,eAAewI,EAAI1I,YAAY4B,QAAQ,GAAGpF,QAAQ,IAAK,QAC3D,MAAO,kBAAkBkM,EAAI1K,iBAAiB0K,EAAI1K,uBAAuB2K,IAAYC,eACpFC,KAAK,GACV,CAoEA,OAjEA7H,EAAKC,iBAAiB,SAAUvF,MAAOwF,IAErC,GADAA,EAAEC,iBACEuG,EAAUoB,SAAU,OAGxB,MAAMC,EAAkBrO,KAAKsO,SAASrB,EAAgBO,MAAON,EAAYM,MAAOL,EAASK,MAAOJ,EAAUI,OAC1G,GAAIa,EAIF,OAHAtB,EAAQ9F,YAAcoH,EACtBtB,EAAQvK,MAAMoL,QAAU,aACxBhM,EAAOoC,UAAU,CAAEE,KAAM,mBAAoBE,QAASiK,IAIxDtB,EAAQvK,MAAMoL,QAAU,OACxBZ,EAAUoB,UAAW,EACrB,MAAMG,EAAevB,EAAU3G,UAC/B2G,EAAU3G,UAAYrG,KAAKwO,uBAE3B,IACE,MAAMC,EAAcxB,EAAgBO,MAAM1L,QAAQ,MAAO,KAClD4M,EAAIC,GAAMzB,EAAYM,MAAM/F,MAAM,KACnC8D,GAAkB,IAAO1E,SAAS8H,GAAM,IAAK,KAAKC,WAgBlDxL,EAA2B,CAC/BC,MAAO,GACPwL,oBAfsBhE,EACtB,CACE1C,OAAQsG,EACRtD,WAAYiC,EAAUI,MAAMsB,OAC5BzD,gBAAiBqD,EACjBnD,iBACA7D,IAAKyF,EAASK,OAEhBxN,KAAKoJ,OACLpJ,KAAKqJ,SACLrJ,KAAKsJ,YAMLhG,aAAc+J,EAAqBxG,SAASwG,EAAmBG,OAAS,EACxEjK,gBAAiBmK,EAAgBe,IAAgB,UACjDhL,SAAU,GACVE,eAAgB8K,EAAY1H,OAAO,GACnClD,eAAgBuJ,EAAUI,MAAMsB,OAChC7O,SAAUD,KAAKC,gBAGX2B,EAAOsB,SAASE,EACxB,CAAE,MAAO2L,GACPhC,EAAQ9F,YAAc8H,EAAI3K,SAAW,8BACrC2I,EAAQvK,MAAMoL,QAAU,QACxBhM,EAAOoC,UAAU,CACfE,KAAM,mBACNE,QAAS2K,EAAI3K,SAAW,8BACxBC,MAAO0K,GAEX,SACE/B,EAAUoB,UAAW,EACrBpB,EAAU3G,UAAYkI,CACxB,IAGF3M,EAAOqB,YAEA,CACLsB,aAAepC,IACb,MAAM6E,EAAWf,EAAYC,cAAc,4BACvCc,IACFA,EAASC,YAAc,MAAM9E,EAAO+E,QAAQ,GAAGpF,QAAQ,IAAK,SAGhE4C,OAAQ1D,UACNsF,EAAKa,cAAc,IAAIC,MAAM,SAAU,CAAE4H,SAAS,EAAMC,YAAY,KAC7D,CAAA,GAETjN,QAAS,KACPiE,EAAYI,UAAY,IAG9B,CAEA,qBAAM1B,CAAgBxC,EAAgB+M,GACpC,MACM3N,EAA+B,GAErC,IAAK,IAAIoH,EAAI,EAAGA,GAHQ,GAGcA,IAAK,CACzC,MAAMnD,EAAemD,GAAK,EACpBC,EAAOpD,EAAe,EAAI,MAC1BF,EAAcE,EAAerD,EAASA,EAAS0G,KAAKC,IAAI,EAAIF,EAAMD,GAClEvD,EAAoBE,EAAcqD,EAEpCvD,GAAqB,GACvB7D,EAAQwH,KAAK,CACXzF,aAAcqF,EACdvD,kBAAmByD,KAAKG,MAA0B,IAApB5D,GAA2B,IACzDE,YAAauD,KAAKG,MAAoB,IAAd1D,GAAqB,IAC7CE,eACAE,aAAcF,EAAe,EAAW,IAAPoD,EACjCjD,YAAmB,IAANgD,GAGnB,CAEA,OAAOpH,CACT,CAEA,OAAAqE,GAEA,CAEQ,QAAA0I,CAAShH,EAAoB6H,EAAgBzH,EAAa3D,GAEhE,GADoBuD,EAAWxF,QAAQ,MAAO,IAC9BiD,OAAS,GAAI,MAAO,4BACpC,GAAIoK,EAAOpK,OAAS,EAAG,MAAO,4BAE9B,MAAO2J,EAAIC,GAAMQ,EAAO1H,MAAM,KACxB2H,EAAQvI,SAAS6H,EAAI,IAC3B,GAAIU,EAAQ,GAAKA,EAAQ,GAAI,MAAO,eAEpC,MAAMC,EAAO,IAAOxI,SAAS8H,GAAM,IAAK,IAClCnF,EAAM,IAAIC,KAChB,OAAI4F,EAAO7F,EAAI8F,eAAkBD,IAAS7F,EAAI8F,eAAiBF,EAAQ5F,EAAI+F,WAAa,EAC/E,kBAGU,IAAf7H,EAAI3C,OAAqB,eACzBhB,EAAK+K,OAAO/J,OAAS,EAAU,gBAC5B,IACT,CAEQ,oBAAAyJ,GACN,MAAO,2lBAST,CAEQ,aAAA1B,CAAclL,GACpB,MAAM4N,EAAkB5N,EAAOO,OAAO+E,QAAQ,GAAGpF,QAAQ,IAAK,KAe9D,MAAO,mzOAgO2B,IAA5BF,EAAOyF,iBAA6B,wKAILmI,sEAG7B,08DAyB4CA,yDAItD,EAIF,SAAS9B,EAAgBvF,GACvB,MAAMsH,EAAQtH,EAAOrG,QAAQ,MAAO,IACpC,MAAI,KAAK4N,KAAKD,GAAe,OACzB,UAAUC,KAAKD,GAAe,aAC9B,SAASC,KAAKD,GAAe,OAC7B,wCAAwCC,KAAKD,IAAU,oBAAoBC,KAAKD,GAAe,MAC/F,UAAUC,KAAKD,GAAe,YAC3B,EACT,OC9faE,EAMX,WAAA5P,CAAoB6B,GAJZ5B,KAAAuB,QAAgC,GAChCvB,KAAA4P,QAA6B,KAC7B5P,KAAA6P,aAA2C,KAGjD7P,KAAK4B,OAAS,CACZyH,SAAUzH,EAAOyH,SACjBC,WAAY1H,EAAO0H,YAAc,GACjCxD,YAAalE,EAAOkE,aAAe,aACnCsD,OAAQxH,EAAOwH,QAAU,6BACzB0G,kBAAmBlO,EAAOkO,wBAAqBC,EAC/CvO,OAAQI,EAAOJ,QAAU,QACzBwO,MAAOpO,EAAOoO,QAAS,EAE3B,CAMA,iBAAa1O,CAAKM,GAChB,MAAMqO,EAAW,IAAIN,EAAe/N,GAEpC,aADMqO,EAASC,eACRD,CACT,CAMQ,kBAAMC,GACZ,MAAMC,EAAM,GAAGnQ,KAAK4B,OAAOwH,8BAA8BpJ,KAAK4B,OAAOyH,mBAErErJ,KAAKoQ,IAAI,qCAAsCD,GAE/C,IACE,MAAMtL,QAAiB8C,MAAMwI,GAE7B,IAAKtL,EAAS2D,GAGZ,OAFAxI,KAAKoQ,IAAI,wCAAyCvL,EAASkF,aAC3D/J,KAAKuB,QAAU,IAIjB,MAAM8O,QAAkCxL,EAAS4D,OACjDzI,KAAKuB,QAAU8O,EAAK9O,SAAW,GAE/BvB,KAAKoQ,IAAI,kBAAmBpQ,KAAKuB,QAAQ0D,IAAI8I,GAAKA,EAAE9N,UACtD,CAAE,MAAO8O,GAEP/O,KAAKoQ,IAAI,mEAAoErB,GAC7E/O,KAAKuB,QAAU,EACjB,CACF,CAWQ,gBAAM+O,GACZ,GAAItQ,KAAK4P,QACP,OAAO5P,KAAK4P,QAId,GAAsC,WAAlC5P,KAAK4B,OAAOkO,kBAEd,OADA9P,KAAKoQ,IAAI,8CACFpQ,KAAKuQ,oBAId,IAAIC,EAASxQ,KAAKuB,QAAQ,GAE1B,GAAIvB,KAAK4B,OAAOkO,kBAAmB,CACjC,MAAMW,EAAYzQ,KAAKuB,QAAQmP,KAC7B3C,GAAKA,EAAE9N,WAAaD,KAAK4B,OAAOkO,mBAE9BW,IACFD,EAASC,EAEb,CAGA,IAAKD,EAEH,OADAxQ,KAAKoQ,IAAI,qFACFpQ,KAAKuQ,oBAMd,OAHAvQ,KAAKoQ,IAAI,aAAcI,EAAOvQ,UAGtBuQ,EAAOvQ,UACb,IAAK,cACHD,KAAK4P,QAAU,IAAI9P,EACnB,MACF,IAAK,YACHE,KAAK4P,QAAU,IAAI/J,EACnB,MACF,QAGE,OADA7F,KAAKoQ,IAAI,yBAAyBI,EAAOvQ,gDAClCD,KAAKuQ,oBAShB,aALMvQ,KAAK4P,QAAQtO,KAAKkP,EAAOnQ,UAAW,CACxCmB,OAAQxB,KAAK4B,OAAOJ,OACpBsE,YAAa0K,EAAO1K,cAGf9F,KAAK4P,OACd,CAKQ,uBAAMW,GAQZ,OAPAvQ,KAAK4P,QAAU,IAAIhD,QACb5M,KAAK4P,QAAQtO,KAAK,GAAI,CAC1B8H,OAAQpJ,KAAK4B,OAAOwH,OACpBC,SAAUrJ,KAAK4B,OAAOyH,SACtBC,WAAYtJ,KAAK4B,OAAO0H,WACxB9H,OAAQxB,KAAK4B,OAAOJ,SAEfxB,KAAK4P,OACd,CASA,uBAAMlO,CACJC,EACAC,GAEA,MAAMgO,QAAgB5P,KAAKsQ,aAK3B,OAHAtQ,KAAKoQ,IAAI,0CAA2CxO,EAAOO,QAE3DnC,KAAK6P,mBAAqBD,EAAQlO,kBAAkBC,EAAWC,GACxD5B,KAAK6P,YACd,CASA,qBAAMlL,CAAgBxC,EAAgByC,GAEpC,aADsB5E,KAAKsQ,cACZ3L,gBAAgBxC,EAAQyC,EACzC,CAKA,qBAAA+L,GACE,MAAO,IAAI3Q,KAAKuB,QAClB,CAKA,SAAAqP,GACE,MAAO,IAAK5Q,KAAK4B,OACnB,CAKA,OAAAgE,GACM5F,KAAK6P,eACP7P,KAAK6P,aAAa7N,UAClBhC,KAAK6P,aAAe,MAElB7P,KAAK4P,UACP5P,KAAK4P,QAAQhK,UACb5F,KAAK4P,QAAU,MAEjB5P,KAAKuB,QAAU,EACjB,CAEQ,GAAA6O,IAAOS,GACT7Q,KAAK4B,OAAOoO,OACdxL,QAAQ4L,IAAI,cAAeS,EAE/B,EClDF,MAAMC,EAAsC,CAC1ClD,QAAS,OACTmD,WAAY,SACZC,eAAgB,SAChBC,IAAK,MACLC,QAAS,YACTC,QAAS,IAGLC,EAAyC,CAC7CC,SAAU,OACVC,WAAY,oEACZC,MAAO,UACPC,cAAe,UAGjB,SAASC,IACP,OACEC,EAAAA,KAAA,MAAA,CAAKC,MAAM,KAAKC,OAAO,KAAKC,QAAQ,YAAYC,KAAK,OAAOC,MAAM,6BAA4BC,SAAA,CAC5FC,EAAAA,IAAA,OAAA,CAAAD,SACEN,OAAA,iBAAA,CAAgB3P,GAAG,mBAAmBmQ,GAAG,KAAKC,GAAG,KAAKC,GAAG,OAAOC,GAAG,OAAML,SAAA,CACvEC,EAAAA,IAAA,OAAA,CAAMK,OAAO,KAAKC,UAAU,YAC5BN,EAAAA,IAAA,OAAA,CAAMK,OAAO,OAAOC,UAAU,iBAGlCN,MAAA,SAAA,CAAQO,GAAG,KAAKC,GAAG,KAAKC,EAAE,KAAKZ,KAAK,2BACpCG,EAAAA,IAAA,OAAA,CAAMzF,EAAE,4CAA4CmG,OAAO,QAAQC,YAAY,IAAIC,cAAc,QAAQC,eAAe,UACxHb,MAAA,SAAA,CAAQO,GAAG,KAAKC,GAAG,KAAKC,EAAE,IAAIZ,KAAK,cAGzC,CCxKA,MAAMiB,EAAiC,IAAIC,IAAI,CAC7C,YACA,SACA,YACA,UACA,WACA,iCDcI,UAA0B3J,SAC9BA,EAAQlH,OACRA,EAAM2D,YACNA,EAAc,aAAYsD,OAC1BA,EAAM0G,kBACNA,EAAiB/M,gBACjBA,EAAkB,GAAEkQ,UACpBA,EAASjP,QACTA,EAAOf,QACPA,EAAOiQ,UACPA,EAASlD,MACTA,GAAQ,IAER,MAAMmD,EAAeC,EAAAA,OAAuB,MACtCC,EAAYD,EAAAA,OAA8B,OACzCE,EAASC,GAAcC,EAAAA,UAAS,IAChCvP,EAAOwP,GAAYD,EAAAA,SAAwB,MAuElD,OArEAE,EAAAA,UAAU,KACR,IAAIC,GAAU,EA2Dd,OAzDA3S,iBACE,GAAKmS,EAAaS,QAElB,IACEL,GAAW,GACXE,EAAS,MAET,MAAM7R,EAAuB,CAC3ByH,WACAvD,cACAsD,SACA0G,oBACAE,SAGI6D,QAAelE,EAAerO,KAAKM,GAEzC,IAAK+R,EAEH,YADAE,EAAOjO,UAITyN,EAAUO,QAAUC,EAEpB,MAAMC,EAAmC,CACvC3R,SACAY,kBACAE,QAAS,KACPsQ,GAAW,GACXtQ,OAEFC,SAAUlC,MAAOqP,IACf4C,EAAU5C,IAEZrM,QAAU+K,IACR0E,EAAS1E,EAAI3K,SACbJ,IAAU+K,WAIR8E,EAAOnS,kBAAkByR,EAAaS,QAASE,EACvD,CAAE,MAAO/E,GACP,GAAI4E,EAAS,CACX,MAAMI,EAAehF,EAAI3K,SAAW,oCACpCqP,EAASM,GACTR,GAAW,GACXvP,IAAU,CACRE,KAAM,aACNE,QAAS2P,EACT1P,MAAO0K,GAEX,CACF,CACF,CAEAiF,GAEO,KACLL,GAAU,EACNN,EAAUO,UACZP,EAAUO,QAAQhO,UAClByN,EAAUO,QAAU,QAGvB,CAACvK,EAAUlH,EAAQ2D,EAAasD,EAAQ0G,IAGzC4B,EAAAA,YAAKwB,UAAWA,EAASlB,SAAA,CACtBsB,GACC5B,OAAA,MAAA,CAAKwB,UAAU,2BACbjB,EAAAA,IAAA,MAAA,CAAKiB,UAAU,mBACfjB,EAAAA,IAAA,OAAA,CAAAD,SAAA,6CAIH/N,GACCgO,MAAA,MAAA,CAAKiB,UAAU,wBACbjB,EAAAA,IAAA,OAAA,CAAAD,SAAO/N,MAIXgO,MAAA,MAAA,CACEgC,IAAKd,EACLpR,GAAG,gCACHS,MAAO,CAAEoL,QAAS0F,EAAU,OAAS,YAGrCA,IAAYrP,GACZyN,EAAAA,KAAA,MAAA,CAAKwB,UAAU,kBAAkB1Q,MAAOsO,YACtCmB,EAAAA,IAACR,MACDQ,EAAAA,IAAA,OAAA,CAAMzP,MAAO4O,sCAKvB,sEC/FE,WAAArR,CAAY6B,GALJ5B,KAAAkU,MAA+C,KAC/ClU,KAAAmU,aAAqD,KACrDnU,KAAAoU,WAA4B,KAC5BpU,KAAAqU,SAAU,EAGhBrU,KAAK4B,OAAS,CACZ0S,YAAa1S,EAAO0S,YACpBC,eAAgB3S,EAAO2S,gBAAc,MAAa,GAClDC,WAAY5S,EAAO4S,YAAU,MAAa,GAC1CxQ,QAASpC,EAAOoC,SAAO,MAAa,GACpCyQ,WAAY7S,EAAO6S,YAAc,IACjCC,UAAW9S,EAAO8S,WAAa,IAEnC,CAGA,KAAAC,GACM3U,KAAKqU,UACTrU,KAAKqU,SAAU,EACfrU,KAAKoU,WAAa,KAGlBpU,KAAK4U,OAGL5U,KAAKkU,MAAQW,YAAY,IAAM7U,KAAK4U,OAAQ5U,KAAK4B,OAAO6S,YAGxDzU,KAAKmU,aAAeW,WAAW,KAC7B9U,KAAK+U,OACL/U,KAAK4B,OAAO2S,eAAe,UAAW,CAAExK,OAAQ,UAAWiL,OAAQ,oBACnEhV,KAAK4B,OAAO4S,WAAW,UAAW,CAAEzK,OAAQ,UAAWiL,OAAQ,qBAC9DhV,KAAK4B,OAAO8S,WACjB,CAGA,IAAAK,GACE/U,KAAKqU,SAAU,EACXrU,KAAKkU,QACPe,cAAcjV,KAAKkU,OACnBlU,KAAKkU,MAAQ,MAEXlU,KAAKmU,eACPe,aAAalV,KAAKmU,cAClBnU,KAAKmU,aAAe,KAExB,CAGA,aAAIgB,GACF,OAAOnV,KAAKqU,OACd,CAEQ,UAAMO,GACZ,GAAK5U,KAAKqU,QAEV,IACE,MAAMhE,QAAarQ,KAAK4B,OAAO0S,cACzBvK,EAASsG,EAAKtG,QAAQ4D,eAAiB,UAEzC5D,IAAW/J,KAAKoU,aAClBpU,KAAKoU,WAAarK,EAClB/J,KAAK4B,OAAO2S,eAAexK,EAAQsG,IAGjC0C,EAAkBqC,IAAIrL,KACxB/J,KAAK+U,OACL/U,KAAK4B,OAAO4S,WAAWzK,EAAQsG,GAEnC,CAAE,MAAOpM,GACPjE,KAAK4B,OAAOoC,QAAQC,EACtB,CACF,aCtGqB,+BLwGjB,SAA+BqF,GAC/BA,EACFL,EAASoM,OAAO/L,GAEhBL,EAASqM,OAEb,8CAlBOtU,eAAqCoI,EAAgBC,EAAkBC,GAC5E,IAEE,aADMH,EAAeC,EAAQC,EAAUC,IAChC,CACT,CAAE,MACA,OAAO,CACT,CACF"}